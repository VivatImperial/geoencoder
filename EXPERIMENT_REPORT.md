# Отчёт по эксперименту: геокодирование адресов Санкт-Петербурга

Документ описывает постановку эксперимента, конфигурацию, метрики и сравнение с внешними методами геокодирования. Изложение нейтральное и ориентировано на воспроизводимость и анализ артефактов.

---

## 1. Цель и постановка

**Цель:** обучить модель, которая по текстовому адресу в границах Санкт-Петербурга и окрестностей предсказывает географические координаты (широта, долгота), и оценить её качество относительно коммерческого геокодера (Dadata) и LLM-based подхода (Mistral).

**Задача:** регрессия «адрес → (lat, lon)» с метрикой качества — расстояние в метрах между истинной и предсказанной точками (Haversine).

**Ограничения:** все адреса относятся к bbox [59.7, 29.6, 60.15, 30.85]; тестовая выборка стратифицирована по признаку «чистый адрес» / «аугментированный адрес».

---

## 2. Данные

- **Источник:** очищенный датасет адресов СПб (`eda_and_cleaning/addresses_spb_cleaned.csv`), собранный из OpenStreetMap (PBF).
- **Разбиение:** train 90% / val 5% / test 5%, фиксированный seed (42). В тест добавлено до `test_overlap_n` примеров из обучающей выборки для оценки качества на «пересекающихся» адресах (in_overlap / no_overlap).
- **Аугментация:** на train/val/test применяется oversample с синтетическими искажениями (в т.ч. SAGE-опечатки). Тестовая выборка содержит ровно половину чистых и половину аугментированных записей после oversample.

---

## 3. Модель и обучение

- **Архитектура:** encoder (deepvk/USER2-small) + регрессионная голова на (lat, lon). Full finetune энкодера.
- **Гиперпараметры:** lr 5e-5, warmup 10%, batch_size 32, max_length 256, градиентный клип 1.0. Обучающая выборка увеличена за счёт oversample с аугментацией (коэффициент 4); val/test oversample 2.
- **Критерий остановки:** ранняя остановка по val (patience 5 эпох); сохранение чекпоинта с наименьшей средней ошибкой (mean distance, м) на валидации.
- **Эксперимент run_2026-02-25_14-50-07:** обучение остановлено до достижения 50 эпох; итоговые метрики и артефакты получены по чекпоинту `best.pt` через скрипт backfill (без переобучения).

---

## 4. Метрики на тестовой выборке

Объём теста: **n = 13 690** (clean: 6845, augmented: 6845).

| Метрика | Overall | Clean | Augmented | In overlap | No overlap |
|---------|---------|-------|-----------|------------|------------|
| Mean (m) | 2042.9 | 2017.2 | 2068.6 | 944.8 | 2194.4 |
| Median (m) | 600.1 | 590.6 | 610.1 | 570.4 | 604.9 |
| P90 (m) | 2549.2 | 2511.7 | 2581.6 | 1826.3 | 2736.8 |
| P95 (m) | 8193.5 | 7872.7 | 8241.4 | 3009.5 | 9756.1 |
| n | 13690 | 6845 | 6845 | 1660 | 12030 |

Интерпретация: медианная ошибка около 600 м; на подмножестве in_overlap ошибки ниже; на аугментированных адресах метрики слегка хуже, чем на чистых.

---

## 5. Ключевые артефакты

| Артефакт | Расположение | Описание |
|----------|--------------|----------|
| Конфиг | `geocoding/experiments/run_2026-02-25_14-50-07/config.json`, копия в `docs/experiment_results/run_2026-02-25_14-50-07/config.json` | Параметры сплита, модели, аугментации, bbox, seed |
| Метрики теста | `geocoding/experiments/.../metrics.json`, копия в `docs/experiment_results/.../metrics.json` | test_metrics (overall, clean, augmented, in_overlap, no_overlap) |
| Предсказания теста | `geocoding/experiments/run_2026-02-25_14-50-07/test_predictions.json` | Построчные: address, true_lat/lon, pred_lat/lon, distance_m, is_augmented |
| Чекпоинт | `geocoding/experiments/run_2026-02-25_14-50-07/best.pt` | Веса модели лучшей эпохи |
| Гистограмма ошибок | `.../error_histogram.png` (в каталоге эксперимента и в `docs/experiment_results/...`) | Распределение ошибки (м) на тесте |
| Scatter lat/lon | `.../scatter_errors.png` | Истинные vs предсказанные координаты |
| Карта ошибок | `geocoding/experiments/run_2026-02-25_14-50-07/map_errors.html` | Интерактивная карта: слой «Правильные (<100 м)», слой «Ошибки» с отрезками истина→предсказание; подсветка пары по клику, перелёт по двойному клику |
| Сводка по эксперименту | `docs/experiment_results/run_2026-02-25_14-50-07/README.md` | Описание конфига, метрик и ссылки на артефакты |

---

## 6. Сравнение с Dadata и Mistral

Сравнение проводится на одной и той же стратифицированной подвыборке теста: **250 чистых и 250 аугментированных адресов** (всего 500). Для внешних API к адресу добавляется префикс «Санкт-Петербург, » для однозначности региона.

- **Наша модель:** предсказания берутся из `test_predictions.json` (без дополнительных вызовов).
- **Dadata:** API clean/address; считаются координаты из ответа (geo_lat, geo_lon при приемлемом qc_geo); пропуски при отсутствии координат.
- **Mistral:** один чат-запрос (mistral-small-latest) с промптом на извлечение lat, lon из адреса; парсинг координат из ответа.

Результаты сравнения (сводка и детали) сохраняются в каталоге `comparing/results/`:

| Файл | Содержание |
|------|-------------|
| `comparison_report.json` | Агрегированные метрики по методам (overall, clean, augmented), число пропусков, оценка стоимости |
| `comparison_summary.md` | Текстовая сводка для быстрого просмотра |
| `comparison_map_data.json` | Построчные координаты: истина, наша модель, Dadata, Mistral (где есть ответ) |
| `comparison_map.html` | Интерактивная карта: истинная точка и три прогноза (наша модель, Dadata, Mistral) с отрезками и слоями |

Метрики в отчёте сравнения: mean/median/p90 (м), n, n_misses, cost_estimate по каждому методу. Итоговые цифры зависят от конкретного прогона (после завершения скрипта `comparing/run_comparison.py` актуальная сводка — в `comparing/results/comparison_summary.md`).

---

## 7. Воспроизведение

1. **Окружение:** Python ≥3.12, зависимости из `pyproject.toml` (в т.ч. torch, transformers, folium, python-dotenv, tqdm). Рекомендуется `uv sync`.
2. **Backfill (без переобучения):**  
   `uv run python geocoding/backfill_experiment.py geocoding/experiments/run_2026-02-25_14-50-07`  
   Обновит тестовые предсказания, метрики, карту ошибок, гистограмму и scatter из `best.pt`.
3. **Сравнение с Dadata и Mistral:**  
   Заполнить `comparing/.env` (DADATA_API_KEY, DADATA_SECRET_KEY, MISTRAL_API_KEY), затем:  
   `uv run python comparing/run_comparison.py --predictions geocoding/experiments/run_2026-02-25_14-50-07 --out comparing/results`  
   По умолчанию используется выборка 250 чистых + 250 аугментированных; при необходимости задать `--sample-clean` и `--sample-augmented`.
4. **Визуализация только карты/графиков по готовым предсказаниям:**  
   `uv run python geocoding/visualize_test.py geocoding/experiments/run_2026-02-25_14-50-07 --out-dir <каталог>`  

---

## 8. Краткие выводы

- Локальная модель на тесте даёт медианную ошибку ~600 м и mean ~2043 м при полном покрытии теста (0 пропусков) и нулевой маржинальной стоимости запроса.
- Качество выше на подмножестве in_overlap и на чистых адресах по сравнению с аугментированными.
- Сравнение с Dadata и Mistral на стратифицированной выборке 250+250 позволяет оценить компромисс «точность / пропуски / стоимость»; актуальные значения метрик — в `comparing/results/comparison_summary.md` и `comparison_report.json`.

Все перечисленные артефакты и пути соответствуют состоянию репозитория после выполнения backfill и (при наличии ключей) прогона сравнения.
