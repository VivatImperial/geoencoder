# Сравнение геокодера с альтернативами

Скрипт сравнивает нашу модель с Dadata и Mistral на тестовой выборке в двух разрезах: **аугментированные** и **неаугментированные** данные. Выводит оценку стоимости прогона и число пропусков. **Результаты сохраняются в JSON** (`comparison_report.json`) и в Markdown (`comparison_summary.md`) в каталоге `--out`.

## Альтернативы в скрипте

| Подход | Описание | Пропуски |
|--------|----------|----------|
| **Our model** | Локальная BERT-модель (предсказания из `test_predictions.json`) | 0 |
| **Dadata** | Геокодирование через API (поиск по адресу, только РФ) | Частичное покрытие: СПб ~91% домов, qc_geo=5 — координаты не определены |
| **Mistral AI** | LLM по промпту: «по адресу верни lat, lon» (без веб-поиска) | Зависит от контекста в модели |

## API и прайсинг (используемые в скрипте)

### 1. Dadata

- **Документация:** https://dadata.ru/api/geocode/
- **Метод:** `POST https://cleaner.dadata.ru/api/v1/clean/address`, тело: JSON-массив строк `["адрес"]`.
- **Ответ:** `geo_lat`, `geo_lon`, `qc_geo` (0=дом … 5=не определены).
- **Лимиты:** 20 запросов/сек с одного IP.
- **Стоимость:** геокодирование **не входит** в подписку: **20 коп. за запрос** (https://dadata.ru/pricing/ ).

### 2. Mistral AI

- **Документация:** https://docs.mistral.ai/api/ (Chat Completion: `POST /v1/chat/completions`).
- **Прайсинг:** https://docs.mistral.ai/deployment/laplateforme/pricing/ , https://mistral.ai/pricing  
  **Mistral Small** — порядка **$0.05 / 1M input**, **$0.08 / 1M output**. Короткий промпт + ответ «lat, lon» ≈ 400 input + 30 output токенов на адрес.

## Стоимость геокодирования: 2ГИС и Яндекс Карты (для полноты сравнения)

В скрипте 2ГИС и Яндекс не вызываются; ниже — ориентировочные данные из открытых источников для сравнения стоимости рынка.

### 2ГИС

- **Документация API:** https://docs.2gis.com/ru/api/search/geocoder/overview  
- **Тарифы:** открытого прайс-листа нет. Стоимость определяется индивидуально в зависимости от пакета запросов, лимитов и опций (карты-основы и т.д.).  
- **Уточнение тарифов:** https://platform.2gis.ru/ru/tariffs , заявка через dev.2gis.ru/api или отдел продаж.

### Яндекс Карты (Геокодер)

- **Продукт:** [Геокодер](https://yandex.ru/maps-api/products/geocoder-api) — конвертация адресов в координаты (и обратно).  
- **Тарифы:** https://yandex.ru/maps-api/tariffs (блок «JavaScript API + Геокодер» / ввод адресов).
- **Стандартная лицензия (ориентир):**
  - до 1 000 запросов/день: **195 000 ₽/год** (или 390 ₽/мес);
  - до 10 000 запросов/день: **585 000 ₽/год** (195 ₽/мес);
  - до 25 000–100 000 запросов/день: от **1 105 000 ₽/год** до **2 184 000 ₽/год**.
- **Сверх лимита:** **390 ₽ за 1 000 запросов**.
- **Расширенная лицензия:** выше (например, до 1 000 запросов/день — 226 200 ₽/год и т.д.).
- **Бесплатно:** до 1 000 запросов/день при соблюдении [условий бесплатного использования](https://yandex.ru/dev/commercial/doc/ru/?from=mapsapi).

## Оценка стоимости одного полного прогона (пример, N ≈ 12 000 адресов)

| Метод | Ориентир | Единица |
|-------|----------|--------|
| Our model | 0 | — |
| Dadata | ~2 400 ₽ | 20 коп/запрос |
| Mistral | ~0,3–0,5 $ | токены (Mistral Small) |

Для быстрой проверки используйте `--sample 500`.

## Запуск

1. Скопировать ключи в `.env`:
   ```bash
   cp comparing/.env.example comparing/.env
   # отредактировать .env (DADATA_*, MISTRAL_*)
   ```

2. Запуск (из корня репозитория):
   ```bash
   uv run python comparing/run_comparison.py --predictions geocoding/experiments/run_XXXX --out comparing/results
   ```
   С лимитом запросов к API:
   ```bash
   uv run python comparing/run_comparison.py --predictions ... --out comparing/results --sample 500
   ```

3. **Результаты:**
   - **JSON:** `comparing/results/comparison_report.json` — полная сводка по методам (overall/clean/augmented, n_misses, cost_estimate).
   - **Markdown:** `comparing/results/comparison_summary.md` — краткая таблица и текстовая сводка.
